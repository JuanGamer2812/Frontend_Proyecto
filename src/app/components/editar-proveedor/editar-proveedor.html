<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Proveedor</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Lora&display=swap" rel="stylesheet">
</head>
<br>

<body>
    <div class="container-xxl py-5">
        <div class="row justify-content-center">
            <div class="col-12 col-xl-10">

                <!-- Loading -->
                @if (loading && !error) {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-3">Cargando datos del proveedor...</p>
                </div>
                }

                <!-- Error -->
                @if (error) {
                <div class="alert alert-danger">
                    <h5><i class="bi bi-exclamation-triangle me-2"></i>Error</h5>
                    <p>{{ error }}</p>
                    <button type="button" class="btn btn-primary" (click)="onCancel()">
                            Volver a la lista
                        </button>
                </div>
                }

                <!-- Formulario -->
                @if (!loading && !error) {
                <div class="shell shadow p-4 rounded bg-white">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="h4 mb-0">
                            <i class="bi bi-pencil-square me-2"></i> Editar Proveedor #{{ proveedorId }}
                        </h2>
                        <button type="button" class="btn btn-outline-secondary" (click)="onCancel()">
                                <i class="bi bi-arrow-left me-1"></i> Volver
                            </button>
                    </div>

                    <form [formGroup]="formProveedor" (ngSubmit)="onSubmit()" novalidate>
                        <h5 class="mb-3"><i class="bi bi-person-bounding-box me-2"></i>Datos del Proveedor</h5>

                        <!-- DATOS GENERALES -->
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Nombre de la Empresa <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" formControlName="nom_empresa_proveedor" placeholder="Ej. Eventos Musicales S.A." [class.is-invalid]="f['nom_empresa_proveedor'].touched && f['nom_empresa_proveedor'].invalid" /> @if
                                (f['nom_empresa_proveedor'].touched && f['nom_empresa_proveedor'].invalid) {
                                <div class="text-danger small mt-1">
                                    @if (f['nom_empresa_proveedor'].hasError('required')) {
                                    <div>Campo obligatorio.</div> } @if (f['nom_empresa_proveedor'].hasError('minlength')) {
                                    <div>Mínimo 3 caracteres.</div> } @if (f['nom_empresa_proveedor'].hasError('maxlength')) {
                                    <div>Máximo 100 caracteres.</div> } @if (f['nom_empresa_proveedor'].hasError('pattern')) {
                                    <div>Solo letras, números, espacios y símbolos: & . -</div> }
                                </div>
                                }
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Categoría <span class="text-danger">*</span></label>
                                <select class="form-select" formControlName="categoria_proveedor" (change)="onCategoryChange($event)" [class.is-invalid]="f['categoria_proveedor'].touched && f['categoria_proveedor'].invalid">
                                        <option value="">Selecciona una categoría</option>
                                        <option value="Musica">Música</option>
                                        <option value="Catering">Catering</option>
                                        <option value="Lugar">Lugar</option>
                                        <option value="Decoracion">Decoración</option>
                                    </select>
                                <small class="text-muted">La categoría no se puede cambiar</small>
                            </div>
                        </div>

                        <!-- Imágenes del proveedor -->
                        <div class="mt-4">
                            <h6><i class="bi bi-images me-2"></i>Imágenes del proveedor</h6>

                            <!-- Imágenes existentes -->
                            @if (imagenes.length > 0) {
                            <div class="row g-3 mb-3">
                                @for (img of imagenes; track img.id) {
                                <div class="col-md-3">
                                    <div class="position-relative">
                                        <img [src]="img.url" [alt]="'Imagen ' + img.id" class="img-fluid rounded" style="max-height: 150px; object-fit: cover; width: 100%;">
                                        <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1" (click)="eliminarImagenExistente(img.id)" title="Eliminar imagen">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                    </div>
                                </div>
                                }
                            </div>
                            } @else {
                            <p class="text-muted small">No hay imágenes actuales</p>
                            }

                            <!-- Botón para añadir nuevas imágenes -->
                            <div class="mb-3">
                                <button type="button" class="btn btn-sm btn-outline-primary" (click)="addNuevaImagenSlot()">
                                    <i class="bi bi-plus-circle me-1"></i> Añadir nueva imagen
                                </button>
                            </div>

                            <!-- Slots para nuevas imágenes -->
                            @if (nuevasImagenesSlots.length > 0) {
                            <div class="row g-3">
                                @for (slot of nuevasImagenesSlots; track slot) {
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <label class="form-label mb-0">Nueva imagen</label>
                                                <button type="button" class="btn btn-sm btn-danger" (click)="eliminarNuevaImagenSlot(slot)">
                                                        <i class="bi bi-x-lg"></i>
                                                    </button>
                                            </div>

                                            <!-- Selector de modo -->
                                            <div class="btn-group btn-group-sm mb-2 w-100" role="group">
                                                <button type="button" class="btn" [class.btn-primary]="nuevasImagenesModos[slot] === 'file'" [class.btn-outline-primary]="nuevasImagenesModos[slot] !== 'file'" (click)="toggleModoNuevaImagen(slot, 'file')">
                                                        <i class="bi bi-upload me-1"></i> Subir archivo
                                                    </button>
                                                <button type="button" class="btn" [class.btn-primary]="nuevasImagenesModos[slot] === 'url'" [class.btn-outline-primary]="nuevasImagenesModos[slot] !== 'url'" (click)="toggleModoNuevaImagen(slot, 'url')">
                                                        <i class="bi bi-link-45deg me-1"></i> URL
                                                    </button>
                                            </div>

                                            <!-- Input de archivo -->
                                            @if (nuevasImagenesModos[slot] === 'file') {
                                            <input type="file" class="form-control form-control-sm" accept="image/*" (change)="onNuevaImagenChange($event, slot)" /> }

                                            <!-- Input de URL -->
                                            @if (nuevasImagenesModos[slot] === 'url') {
                                            <input type="url" class="form-control form-control-sm" placeholder="https://ejemplo.com/imagen.jpg" [(ngModel)]="nuevasImagenesUrls[slot]" [ngModelOptions]="{standalone: true}" (ngModelChange)="onNuevaImagenUrlChange(slot, $event)" />                                            }

                                            <!-- Vista previa -->
                                            @if (nuevasImagenesPreviews[slot]) {
                                            <div class="mt-2">
                                                <img [src]="nuevasImagenesPreviews[slot]" alt="Vista previa" class="img-thumbnail w-100" style="max-height: 150px; object-fit: cover;" />
                                            </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                                }
                            </div>
                            }
                        </div>

                        <hr class="my-4">

                        <!-- MÚSICA -->
                        @if (isMusica()) {
                        <div formGroupName="musica">
                            <h5><i class="bi bi-music-note me-2"></i>Datos específicos - Música</h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Género musical</label>
                                    <input type="text" class="form-control" formControlName="genero" placeholder="Ej. Rock, Salsa, Electrónica" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Precio</label>
                                    <input type="number" class="form-control" formControlName="precio" placeholder="Ej. 150" />
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">¿Cobro por hora?</label>
                                    <select class="form-select" formControlName="porHora">
                                                <option value="">Seleccione</option>
                                                <option value="si">Sí</option>
                                                <option value="no">No</option>
                                            </select>
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">Hora inicio</label>
                                    <input type="time" class="form-control" formControlName="horaInicio" />
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">Hora fin</label>
                                    <input type="time" class="form-control" formControlName="horaFin" />
                                </div>

                                <div class="col-12">
                                    <label class="form-label">Descripción</label>
                                    <textarea class="form-control" formControlName="descripcion" rows="3" placeholder="Describe el servicio musical"></textarea>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Plan</label>
                                    <select class="form-select" formControlName="plan">
                                                <option value="">Seleccione plan</option>
                                                @for (p of planes; track p.id_plan) {
                                                    <option [value]="p.id_plan">{{ p.nombre_plan }}</option>
                                                }
                                            </select>
                                </div>

                                <!-- Características dinámicas -->
                                @if (caracteristicas.length > 0) {
                                <div class="col-12 mt-3">
                                    <h6><i class="bi bi-list-check me-2"></i>Características adicionales</h6>
                                    <div class="row g-3">
                                        @for (car of caracteristicas; track car.id_caracteristica) {
                                        <div class="col-md-6">
                                            <label class="form-label">{{ car.nombre }}</label>
                                            @if (esMenuCaracteristicaNombre(car.nombre)) {
                                            <div>
                                                @if (car.valor && esCaracteristicaFileUrlValor(car.valor)) {
                                                <button type="button" (click)="abrirPdfModal(resolveAssetUrl(car.valor), car.nombre)" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-eye me-1"></i> Ver menu
                                                </button>
                                                }
                                                <div class="btn-group btn-group-sm mt-2 w-100" role="group">
                                                    <button type="button" class="btn" [class.btn-primary]="getMenuInputMode(car) === 'file'" [class.btn-outline-primary]="getMenuInputMode(car) !== 'file'" (click)="setMenuInputMode(car, 'file')">
                                                        <i class="bi bi-upload me-1"></i> Subir archivo
                                                    </button>
                                                    <button type="button" class="btn" [class.btn-primary]="getMenuInputMode(car) === 'url'" [class.btn-outline-primary]="getMenuInputMode(car) !== 'url'" (click)="setMenuInputMode(car, 'url')">
                                                        <i class="bi bi-link-45deg me-1"></i> URL
                                                    </button>
                                                </div>
                                                @if (getMenuInputMode(car) === 'file') {
                                                <input type="file" class="form-control mt-2" accept="application/pdf" (change)="onMenuCaracteristicaFileChange($event, car)" />
                                                }
                                                @if (getMenuInputMode(car) === 'url') {
                                                <input type="url" class="form-control mt-2" placeholder="https://ejemplo.com/menu.pdf" [(ngModel)]="menuUrlInputs[car.id_caracteristica ?? car.id]" [ngModelOptions]="{standalone: true}" (ngModelChange)="onMenuCaracteristicaUrlChange(car, $event)" />
                                                }
                                            </div>
                                            } @else if (car.nombre?.toLowerCase().includes('pdf') && car.valor) {
                                            <div>
                                                <button type="button" (click)="abrirPdfModal(car.valor, car.nombre)" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-file-pdf me-1"></i> Ver PDF
                                                </button>
                                                <input type="text" class="form-control mt-2" [(ngModel)]="car.valor" [ngModelOptions]="{standalone: true}" placeholder="URL del PDF">
                                            </div>
                                            } @else if (car.nombre?.toLowerCase().includes('url') && car.valor) {
                                            <div>
                                                <a [href]="car.valor" target="_blank" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-link-45deg me-1"></i> Abrir link
                                                </a>
                                                <input type="text" class="form-control mt-2" [(ngModel)]="car.valor" [ngModelOptions]="{standalone: true}" placeholder="URL del enlace">
                                            </div>
                                            } @else if (car.tipo === 'texto') {
                                            <input type="text" class="form-control" [(ngModel)]="car.valor" [ngModelOptions]="{standalone: true}"> } @else if (car.tipo === 'numero' || car.tipo === 'number') {
                                            <input type="number" class="form-control" [(ngModel)]="car.valor" [ngModelOptions]="{standalone: true}"> } @else if (car.tipo === 'booleano' || car.tipo === 'boolean') {
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" [(ngModel)]="car.valor" [ngModelOptions]="{standalone: true}" [id]="'car_' + car.id_caracteristica">
                                                <label class="form-check-label" [for]="'car_' + car.id_caracteristica">Sí</label>
                                            </div>
                                            } @else if (car.tipo === 'opcion' && car.opciones) {
                                            <select class="form-select" [(ngModel)]="car.valor" [ngModelOptions]="{standalone: true}">
                                                    <option value="">Seleccione</option>
                                                    @for (op of car.opciones; track op) {
                                                        <option [value]="op">{{ op }}</option>
                                                    }
                                                </select> }
                                        </div>
                                        }
                                    </div>
                                </div>
                                }
                            </div>
                        </div>
                        }

                        <!-- CATERING -->
                        @if (isCatering()) {
                        <div formGroupName="catering">
                            <h5><i class="bi bi-cup-hot me-2"></i>Datos específicos - Catering</h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Tipo de comida</label>
                                    <input type="text" class="form-control" formControlName="tipoComida" placeholder="Ej. Internacional, Buffet, Formal" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Precio por persona</label>
                                    <input type="number" class="form-control" formControlName="precioPersona" placeholder="Ej. 25" />
                                </div>

                                <div class="col-12">
                                    <label class="form-label">Descripción</label>
                                    <textarea class="form-control" formControlName="descripcion" rows="3" placeholder="Describe el servicio de catering"></textarea>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Plan</label>
                                    <select class="form-select" formControlName="plan">
                                                <option value="">Seleccione plan</option>
                                                @for (p of planes; track p.id_plan) {
                                                    <option [value]="p.id_plan">{{ p.nombre_plan }}</option>
                                                }
                                            </select>
                                </div>

                                <!-- Características dinámicas -->
                                @if (caracteristicas.length > 0) {
                                <div class="col-12 mt-3">
                                    <h6><i class="bi bi-list-check me-2"></i>Características adicionales</h6>
                                    <div class="row g-3">
                                        @for (car of caracteristicas; track car.id_caracteristica) {
                                        <div class="col-md-6">
                                            <label class="form-label">{{ car.nombre }}</label>
                                            @if (esMenuCaracteristicaNombre(car.nombre)) {
                                            <div>
                                                @if (car.valor && esCaracteristicaFileUrlValor(car.valor)) {
                                                <button type="button" (click)="abrirPdfModal(resolveAssetUrl(car.valor), car.nombre)" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-eye me-1"></i> Ver menu
                                                </button>
                                                }
                                                <div class="btn-group btn-group-sm mt-2 w-100" role="group">
                                                    <button type="button" class="btn" [class.btn-primary]="getMenuInputMode(car) === 'file'" [class.btn-outline-primary]="getMenuInputMode(car) !== 'file'" (click)="setMenuInputMode(car, 'file')">
                                                        <i class="bi bi-upload me-1"></i> Subir archivo
                                                    </button>
                                                    <button type="button" class="btn" [class.btn-primary]="getMenuInputMode(car) === 'url'" [class.btn-outline-primary]="getMenuInputMode(car) !== 'url'" (click)="setMenuInputMode(car, 'url')">
                                                        <i class="bi bi-link-45deg me-1"></i> URL
                                                    </button>
                                                </div>
                                                @if (getMenuInputMode(car) === 'file') {
                                                <input type="file" class="form-control mt-2" accept="application/pdf" (change)="onMenuCaracteristicaFileChange($event, car)" />
                                                }
                                                @if (getMenuInputMode(car) === 'url') {
                                                <input type="url" class="form-control mt-2" placeholder="https://ejemplo.com/menu.pdf" [(ngModel)]="menuUrlInputs[car.id_caracteristica ?? car.id]" [ngModelOptions]="{standalone: true}" (ngModelChange)="onMenuCaracteristicaUrlChange(car, $event)" />
                                                }
                                            </div>
                                            } @else if (car.nombre?.toLowerCase().includes('pdf')) {
                                            <div>
                                                @if (car.valor) {
                                                <button type="button" (click)="abrirPdfModal(car.valor, car.nombre)" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-file-pdf me-1"></i> Ver PDF
                                                </button> }
                                                <input type="text" class="form-control mt-2" [(ngModel)]="car.valor" [ngModelOptions]="{standalone: true}" placeholder="URL del PDF">
                                            </div>
                                            } @else if (car.nombre?.toLowerCase().includes('url')) {
                                            <div>
                                                @if (car.valor) {
                                                <a [href]="car.valor" target="_blank" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-link-45deg me-1"></i> Abrir link
                                                </a>
                                                }
                                                <input type="text" class="form-control mt-2" [(ngModel)]="car.valor" [ngModelOptions]="{standalone: true}" placeholder="URL del enlace">
                                            </div>
                                            } @else if (car.tipo === 'texto') {
                                            <input type="text" class="form-control" [(ngModel)]="car.valor" [ngModelOptions]="{standalone: true}"> } @else if (car.tipo === 'numero' || car.tipo === 'number') {
                                            <input type="number" class="form-control" [(ngModel)]="car.valor" [ngModelOptions]="{standalone: true}"> } @else if (car.tipo === 'booleano' || car.tipo === 'boolean') {
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" [(ngModel)]="car.valor" [ngModelOptions]="{standalone: true}" [id]="'car_' + car.id_caracteristica">
                                                <label class="form-check-label" [for]="'car_' + car.id_caracteristica">Sí</label>
                                            </div>
                                            } @else if (car.tipo === 'opcion' && car.opciones) {
                                            <select class="form-select" [(ngModel)]="car.valor" [ngModelOptions]="{standalone: true}">
                                                    <option value="">Seleccione</option>
                                                    @for (op of car.opciones; track op) {
                                                        <option [value]="op">{{ op }}</option>
                                                    }
                                                </select> }
                                        </div>
                                        }
                                    </div>
                                </div>
                                }
                            </div>
                        </div>
                        }

                        <!-- LUGAR -->
                        @if (isLugar()) {
                        <div formGroupName="lugar">
                            <h5><i class="bi bi-building me-2"></i>Datos específicos - Lugar</h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Capacidad</label>
                                    <input type="number" class="form-control" formControlName="capacidad" placeholder="Ej. 200 personas" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Precio</label>
                                    <input type="number" class="form-control" formControlName="precio" placeholder="Ej. 500" />
                                </div>

                                <div class="col-12">
                                    <label class="form-label">Dirección</label>
                                    <input type="text" class="form-control" formControlName="direccion" placeholder="Ej. Av. Principal 123, Ciudad" />
                                </div>

                                <div class="col-12">
                                    <label class="form-label">Descripción</label>
                                    <textarea class="form-control" formControlName="descripcion" rows="3" placeholder="Describe el lugar"></textarea>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">¿Tiene seguridad?</label>
                                    <select class="form-select" formControlName="seguridad">
                                                <option value="">Seleccione</option>
                                                <option value="si">Sí</option>
                                                <option value="no">No</option>
                                            </select>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Plan</label>
                                    <select class="form-select" formControlName="plan">
                                                <option value="">Seleccione plan</option>
                                                @for (p of planes; track p.id_plan) {
                                                    <option [value]="p.id_plan">{{ p.nombre_plan }}</option>
                                                }
                                            </select>
                                </div>

                                <!-- Características dinámicas -->
                                @if (caracteristicas.length > 0) {
                                <div class="col-12 mt-3">
                                    <h6><i class="bi bi-list-check me-2"></i>Características adicionales</h6>
                                    <div class="row g-3">
                                        @for (car of caracteristicas; track car.id_caracteristica) {
                                        <div class="col-md-6">
                                            <label class="form-label">{{ car.nombre }}</label>
                                            @if (esMenuCaracteristicaNombre(car.nombre)) {
                                            <div>
                                                @if (car.valor && esCaracteristicaFileUrlValor(car.valor)) {
                                                <button type="button" (click)="abrirPdfModal(resolveAssetUrl(car.valor), car.nombre)" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-eye me-1"></i> Ver menu
                                                </button>
                                                }
                                                <div class="btn-group btn-group-sm mt-2 w-100" role="group">
                                                    <button type="button" class="btn" [class.btn-primary]="getMenuInputMode(car) === 'file'" [class.btn-outline-primary]="getMenuInputMode(car) !== 'file'" (click)="setMenuInputMode(car, 'file')">
                                                        <i class="bi bi-upload me-1"></i> Subir archivo
                                                    </button>
                                                    <button type="button" class="btn" [class.btn-primary]="getMenuInputMode(car) === 'url'" [class.btn-outline-primary]="getMenuInputMode(car) !== 'url'" (click)="setMenuInputMode(car, 'url')">
                                                        <i class="bi bi-link-45deg me-1"></i> URL
                                                    </button>
                                                </div>
                                                @if (getMenuInputMode(car) === 'file') {
                                                <input type="file" class="form-control mt-2" accept="application/pdf" (change)="onMenuCaracteristicaFileChange($event, car)" />
                                                }
                                                @if (getMenuInputMode(car) === 'url') {
                                                <input type="url" class="form-control mt-2" placeholder="https://ejemplo.com/menu.pdf" [(ngModel)]="menuUrlInputs[car.id_caracteristica ?? car.id]" [ngModelOptions]="{standalone: true}" (ngModelChange)="onMenuCaracteristicaUrlChange(car, $event)" />
                                                }
                                            </div>
                                            } @else if (car.nombre?.toLowerCase().includes('pdf')) {
                                            <div>
                                                @if (car.valor) {
                                                <button type="button" (click)="abrirPdfModal(car.valor, car.nombre)" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-file-pdf me-1"></i> Ver PDF
                                                </button> }
                                                <input type="text" class="form-control mt-2" [(ngModel)]="car.valor" [ngModelOptions]="{standalone: true}" placeholder="URL del PDF">
                                            </div>
                                            } @else if (car.nombre?.toLowerCase().includes('url')) {
                                            <div>
                                                @if (car.valor) {
                                                <a [href]="car.valor" target="_blank" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-link-45deg me-1"></i> Abrir link
                                                </a>
                                                }
                                                <input type="text" class="form-control mt-2" [(ngModel)]="car.valor" [ngModelOptions]="{standalone: true}" placeholder="URL del enlace">
                                            </div>
                                            } @else if (car.tipo === 'texto') {
                                            <input type="text" class="form-control" [(ngModel)]="car.valor" [ngModelOptions]="{standalone: true}"> } @else if (car.tipo === 'numero' || car.tipo === 'number') {
                                            <input type="number" class="form-control" [(ngModel)]="car.valor" [ngModelOptions]="{standalone: true}"> } @else if (car.tipo === 'booleano' || car.tipo === 'boolean') {
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" [(ngModel)]="car.valor" [ngModelOptions]="{standalone: true}" [id]="'car_' + car.id_caracteristica">
                                                <label class="form-check-label" [for]="'car_' + car.id_caracteristica">Sí</label>
                                            </div>
                                            } @else if (car.tipo === 'opcion' && car.opciones) {
                                            <select class="form-select" [(ngModel)]="car.valor" [ngModelOptions]="{standalone: true}">
                                                    <option value="">Seleccione</option>
                                                    @for (op of car.opciones; track op) {
                                                        <option [value]="op">{{ op }}</option>
                                                    }
                                                </select> }
                                        </div>
                                        }
                                    </div>
                                </div>
                                }
                            </div>
                        </div>
                        }

                        <!-- DECORACIÓN -->
                        @if (isDecoracion()) {
                        <div formGroupName="decoracion">
                            <h5><i class="bi bi-palette me-2"></i>Datos específicos - Decoración</h5>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Nivel</label>
                                    <select class="form-select" formControlName="nivel">
                                                <option value="">Seleccione nivel</option>
                                                <option value="basico">Básico</option>
                                                <option value="intermedio">Intermedio</option>
                                                <option value="premium">Premium</option>
                                            </select>
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">Tipo</label>
                                    <input type="text" class="form-control" formControlName="tipo" placeholder="Ej. Bodas, Cumpleaños" />
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">Precio</label>
                                    <input type="number" class="form-control" formControlName="precio" placeholder="Ej. 300" />
                                </div>

                                <!-- Características dinámicas -->
                                @if (caracteristicas.length > 0) {
                                <div class="col-12 mt-3">
                                    <h6><i class="bi bi-list-check me-2"></i>Características adicionales</h6>
                                    <div class="row g-3">
                                        @for (car of caracteristicas; track car.id_caracteristica) {
                                        <div class="col-md-6">
                                            <label class="form-label">{{ car.nombre }}</label>
                                            @if (esMenuCaracteristicaNombre(car.nombre)) {
                                            <div>
                                                @if (car.valor && esCaracteristicaFileUrlValor(car.valor)) {
                                                <button type="button" (click)="abrirPdfModal(resolveAssetUrl(car.valor), car.nombre)" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-eye me-1"></i> Ver menu
                                                </button>
                                                }
                                                <div class="btn-group btn-group-sm mt-2 w-100" role="group">
                                                    <button type="button" class="btn" [class.btn-primary]="getMenuInputMode(car) === 'file'" [class.btn-outline-primary]="getMenuInputMode(car) !== 'file'" (click)="setMenuInputMode(car, 'file')">
                                                        <i class="bi bi-upload me-1"></i> Subir archivo
                                                    </button>
                                                    <button type="button" class="btn" [class.btn-primary]="getMenuInputMode(car) === 'url'" [class.btn-outline-primary]="getMenuInputMode(car) !== 'url'" (click)="setMenuInputMode(car, 'url')">
                                                        <i class="bi bi-link-45deg me-1"></i> URL
                                                    </button>
                                                </div>
                                                @if (getMenuInputMode(car) === 'file') {
                                                <input type="file" class="form-control mt-2" accept="application/pdf" (change)="onMenuCaracteristicaFileChange($event, car)" />
                                                }
                                                @if (getMenuInputMode(car) === 'url') {
                                                <input type="url" class="form-control mt-2" placeholder="https://ejemplo.com/menu.pdf" [(ngModel)]="menuUrlInputs[car.id_caracteristica ?? car.id]" [ngModelOptions]="{standalone: true}" (ngModelChange)="onMenuCaracteristicaUrlChange(car, $event)" />
                                                }
                                            </div>
                                            } @else if (car.nombre?.toLowerCase().includes('pdf')) {
                                            <div>
                                                @if (car.valor) {
                                                <button type="button" (click)="abrirPdfModal(car.valor, car.nombre)" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-file-pdf me-1"></i> Ver PDF
                                                </button> }
                                                <input type="text" class="form-control mt-2" [(ngModel)]="car.valor" [ngModelOptions]="{standalone: true}" placeholder="URL del PDF">
                                            </div>
                                            } @else if (car.nombre?.toLowerCase().includes('url')) {
                                            <div>
                                                @if (car.valor) {
                                                <a [href]="car.valor" target="_blank" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-link-45deg me-1"></i> Abrir link
                                                </a>
                                                }
                                                <input type="text" class="form-control mt-2" [(ngModel)]="car.valor" [ngModelOptions]="{standalone: true}" placeholder="URL del enlace">
                                            </div>
                                            } @else if (car.tipo === 'texto') {
                                            <input type="text" class="form-control" [(ngModel)]="car.valor" [ngModelOptions]="{standalone: true}"> } @else if (car.tipo === 'numero' || car.tipo === 'number') {
                                            <input type="number" class="form-control" [(ngModel)]="car.valor" [ngModelOptions]="{standalone: true}"> } @else if (car.tipo === 'booleano' || car.tipo === 'boolean') {
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" [(ngModel)]="car.valor" [ngModelOptions]="{standalone: true}" [id]="'car_' + car.id_caracteristica">
                                                <label class="form-check-label" [for]="'car_' + car.id_caracteristica">Sí</label>
                                            </div>
                                            } @else if (car.tipo === 'opcion' && car.opciones) {
                                            <select class="form-select" [(ngModel)]="car.valor" [ngModelOptions]="{standalone: true}">
                                                    <option value="">Seleccione</option>
                                                    @for (op of car.opciones; track op) {
                                                        <option [value]="op">{{ op }}</option>
                                                    }
                                                </select> }
                                        </div>
                                        }
                                    </div>
                                </div>
                                }
                            </div>
                        </div>
                        }

                        <hr class="my-4">

                        <!-- Botones de acción -->
                        <div class="d-flex justify-content-between align-items-center">
                            <button type="button" class="btn btn-outline-secondary" (click)="onCancel()" [disabled]="loading">
                                    <i class="bi bi-x-circle me-1"></i> Cancelar
                                </button>

                            <button type="submit" class="btn btn-primary" [disabled]="loading || formProveedor.invalid">
                                    @if (loading) {
                                        <span class="spinner-border spinner-border-sm me-1"></span>
                                    } @else {
                                        <i class="bi bi-check-circle me-1"></i>
                                    }
                                    Guardar Cambios
                                </button>
                        </div>
                    </form>
                </div>
                }
            </div>
        </div>
    </div>
</body>

<!-- Modal para visualizar PDFs -->
<app-pdf-viewer-modal [isVisible]="mostrarPdfModal" [pdfUrl]="pdfUrl" [fileName]="pdfFileName" (close)="cerrarPdfModal()"></app-pdf-viewer-modal>