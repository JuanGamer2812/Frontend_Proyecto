<div class="container-fluid py-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="border-bottom border-3 border-primary pb-3">
        <h1 class="fw-bold text-dark d-flex align-items-center gap-3">
          <i class="bi bi-cloud-upload text-primary"></i>
          Envío Masivo de Invitaciones
        </h1>
        <p class="text-muted mb-0">Importa invitados desde CSV y envía invitaciones en lote</p>
      </div>
    </div>
  </div>

  <!-- Progress Steps -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <!-- Paso 1 -->
            <div class="text-center flex-fill">
              <div class="rounded-circle d-inline-flex align-items-center justify-content-center"
                   [class.bg-primary]="paso() >= 1"
                   [class.bg-secondary]="paso() < 1"
                   [class.text-white]="true"
                   style="width: 50px; height: 50px;">
                <i class="bi bi-file-earmark-arrow-up fs-4"></i>
              </div>
              <div class="mt-2 fw-semibold" [class.text-primary]="paso() >= 1">1. Cargar CSV</div>
            </div>

            <div class="flex-grow-1 border-top" [class.border-primary]="paso() >= 2" [class.border-secondary]="paso() < 2"></div>

            <!-- Paso 2 -->
            <div class="text-center flex-fill">
              <div class="rounded-circle d-inline-flex align-items-center justify-content-center"
                   [class.bg-primary]="paso() >= 2"
                   [class.bg-secondary]="paso() < 2"
                   [class.text-white]="true"
                   style="width: 50px; height: 50px;">
                <i class="bi bi-eye fs-4"></i>
              </div>
              <div class="mt-2 fw-semibold" [class.text-primary]="paso() >= 2">2. Revisar</div>
            </div>

            <div class="flex-grow-1 border-top" [class.border-primary]="paso() >= 3" [class.border-secondary]="paso() < 3"></div>

            <!-- Paso 3 -->
            <div class="text-center flex-fill">
              <div class="rounded-circle d-inline-flex align-items-center justify-content-center"
                   [class.bg-primary]="paso() >= 3"
                   [class.bg-secondary]="paso() < 3"
                   [class.text-white]="true"
                   style="width: 50px; height: 50px;">
                <i class="bi bi-gear fs-4"></i>
              </div>
              <div class="mt-2 fw-semibold" [class.text-primary]="paso() >= 3">3. Procesar</div>
            </div>

            <div class="flex-grow-1 border-top" [class.border-primary]="paso() >= 4" [class.border-secondary]="paso() < 4"></div>

            <!-- Paso 4 -->
            <div class="text-center flex-fill">
              <div class="rounded-circle d-inline-flex align-items-center justify-content-center"
                   [class.bg-primary]="paso() >= 4"
                   [class.bg-secondary]="paso() < 4"
                   [class.text-white]="true"
                   style="width: 50px; height: 50px;">
                <i class="bi bi-check-circle fs-4"></i>
              </div>
              <div class="mt-2 fw-semibold" [class.text-primary]="paso() >= 4">4. Completado</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PASO 1: Upload CSV -->
  @if (paso() === 1) {
    <div class="row">
      <div class="col-lg-8 mx-auto">
        <div class="card shadow-sm">
          <div class="card-body p-5">
            <!-- Selector de Evento -->
            <div class="mb-4">
              <label class="form-label fw-semibold d-flex align-items-center gap-2">
                <i class="bi bi-calendar-event text-primary"></i>
                Selecciona el Evento
              </label>
              <select class="form-select form-select-lg" (change)="seleccionarEvento($event)">
                <option [value]="null">-- Selecciona un evento --</option>
                @for (evento of eventos(); track evento.id_evento) {
                  <option [value]="evento.id_evento">
                    {{ evento.nombre_evento }} - {{ formatearFecha(evento.fecha_evento) }}
                  </option>
                }
              </select>
            </div>

            @if (eventoSeleccionado()) {
              <!-- Zona de Upload -->
              <div class="border border-3 border-dashed rounded-3 p-5 text-center bg-light mb-4">
                <i class="bi bi-cloud-arrow-up display-1 text-primary mb-3"></i>
                <h4 class="mb-3">Arrastra tu archivo CSV aquí</h4>
                <p class="text-muted mb-3">o haz clic para seleccionar</p>
                <input 
                  type="file" 
                  class="form-control d-none" 
                  id="csvFile"
                  accept=".csv"
                  (change)="onFileSelected($event)">
                <label for="csvFile" class="btn btn-primary btn-lg">
                  <i class="bi bi-folder-open me-2"></i>
                  Seleccionar Archivo CSV
                </label>
              </div>

              @if (archivoSeleccionado()) {
                <div class="alert alert-success d-flex align-items-center">
                  <i class="bi bi-check-circle-fill fs-4 me-3"></i>
                  <div>
                    <strong>Archivo cargado:</strong> {{ archivoSeleccionado()!.name }}
                  </div>
                </div>
              }

              <!-- Plantilla -->
              <div class="card bg-info-subtle border-info">
                <div class="card-body">
                  <h5 class="card-title d-flex align-items-center gap-2">
                    <i class="bi bi-info-circle-fill text-info"></i>
                    Formato del CSV
                  </h5>
                  <p class="card-text mb-3">El archivo debe tener las siguientes columnas en la primera fila:</p>
                  <code class="d-block bg-white p-3 rounded mb-3">
                    Nombre,Email,Telefono,Acompanantes,Categoria
                  </code>
                  <button class="btn btn-info" (click)="descargarPlantilla()">
                    <i class="bi bi-download me-2"></i>
                    Descargar Plantilla
                  </button>
                </div>
              </div>
            }
          </div>
        </div>
      </div>
    </div>
  }

  <!-- PASO 2: Preview -->
  @if (paso() === 2) {
    <div class="row">
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0 d-flex align-items-center gap-2">
              <i class="bi bi-eye"></i>
              Vista Previa de Invitados
            </h5>
          </div>
          <div class="card-body">
            <!-- Resumen -->
            <div class="row g-3 mb-4">
              <div class="col-md-4">
                <div class="card bg-success-subtle border-success">
                  <div class="card-body text-center">
                    <i class="bi bi-check-circle-fill text-success fs-1"></i>
                    <h3 class="fw-bold mt-2">{{ invitadosValidos().length }}</h3>
                    <p class="mb-0 text-muted">Válidos</p>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card bg-danger-subtle border-danger">
                  <div class="card-body text-center">
                    <i class="bi bi-x-circle-fill text-danger fs-1"></i>
                    <h3 class="fw-bold mt-2">{{ invitadosInvalidos().length }}</h3>
                    <p class="mb-0 text-muted">Con Errores</p>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card bg-primary-subtle border-primary">
                  <div class="card-body text-center">
                    <i class="bi bi-people-fill text-primary fs-1"></i>
                    <h3 class="fw-bold mt-2">{{ invitadosCSV().length }}</h3>
                    <p class="mb-0 text-muted">Total</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tabs -->
            <ul class="nav nav-tabs mb-3" role="tablist">
              <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#validos">
                  <i class="bi bi-check-circle me-2"></i>
                  Válidos ({{ invitadosValidos().length }})
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#invalidos">
                  <i class="bi bi-x-circle me-2"></i>
                  Con Errores ({{ invitadosInvalidos().length }})
                </button>
              </li>
            </ul>

            <div class="tab-content">
              <!-- Tab Válidos -->
              <div class="tab-pane fade show active" id="validos">
                @if (invitadosValidos().length > 0) {
                  <div class="table-responsive">
                    <table class="table table-hover table-striped">
                      <thead class="table-success">
                        <tr>
                          <th>Nombre</th>
                          <th>Email</th>
                          <th>Teléfono</th>
                          <th>Acompañantes</th>
                          <th>Categoría</th>
                        </tr>
                      </thead>
                      <tbody>
                        @for (inv of invitadosValidos(); track inv.email) {
                          <tr>
                            <td class="fw-semibold">{{ inv.nombre_invitado }}</td>
                            <td>{{ inv.email }}</td>
                            <td>{{ inv.telefono || '-' }}</td>
                            <td class="text-center">{{ inv.numero_acompanantes }}</td>
                            <td>
                              <span class="badge bg-info">{{ inv.categoria || 'general' }}</span>
                            </td>
                          </tr>
                        }
                      </tbody>
                    </table>
                  </div>
                } @else {
                  <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    No hay invitados válidos para procesar
                  </div>
                }
              </div>

              <!-- Tab Inválidos -->
              <div class="tab-pane fade" id="invalidos">
                @if (invitadosInvalidos().length > 0) {
                  <div class="table-responsive">
                    <table class="table table-hover">
                      <thead class="table-danger">
                        <tr>
                          <th>Nombre</th>
                          <th>Email</th>
                          <th>Errores</th>
                        </tr>
                      </thead>
                      <tbody>
                        @for (inv of invitadosInvalidos(); track inv.email) {
                          <tr>
                            <td>{{ inv.nombre_invitado }}</td>
                            <td>{{ inv.email }}</td>
                            <td>
                              @for (error of inv.errores; track error) {
                                <span class="badge bg-danger me-1">{{ error }}</span>
                              }
                            </td>
                          </tr>
                        }
                      </tbody>
                    </table>
                  </div>
                } @else {
                  <div class="alert alert-success">
                    <i class="bi bi-check-circle me-2"></i>
                    ¡Todos los invitados son válidos!
                  </div>
                }
              </div>
            </div>

            <!-- Opciones -->
            <div class="card bg-light mt-4">
              <div class="card-body">
                <div class="form-check form-switch">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    id="enviarEmails"
                    [checked]="enviarEmailsInmediatamente()"
                    (change)="enviarEmailsInmediatamente.set(!enviarEmailsInmediatamente())">
                  <label class="form-check-label" for="enviarEmails">
                    <strong>Enviar emails automáticamente después de crear</strong>
                    <p class="text-muted small mb-0">Si está desactivado, podrás enviar los emails manualmente después</p>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div class="card-footer bg-white">
            <div class="d-flex justify-content-between">
              <button class="btn btn-secondary" (click)="volverPaso()">
                <i class="bi bi-arrow-left me-2"></i>
                Volver
              </button>
              <div class="d-flex gap-2">
                <button class="btn btn-outline-danger" (click)="cancelar()">
                  Cancelar
                </button>
                <button 
                  class="btn btn-success btn-lg"
                  (click)="procesarInvitaciones()"
                  [disabled]="invitadosValidos().length === 0">
                  <i class="bi bi-rocket-takeoff me-2"></i>
                  Procesar {{ invitadosValidos().length }} Invitaciones
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- PASO 3: Procesando -->
  @if (paso() === 3) {
    <div class="row">
      <div class="col-lg-6 mx-auto">
        <div class="card shadow-sm">
          <div class="card-body text-center p-5">
            <div class="spinner-border text-primary mb-4" style="width: 4rem; height: 4rem;" role="status">
              <span class="visually-hidden">Procesando...</span>
            </div>
            <h3 class="mb-3">Procesando Invitaciones...</h3>
            <p class="text-muted mb-4">Por favor espera mientras se crean y envían las invitaciones</p>
            
            <!-- Progress Bar -->
            <div class="progress" style="height: 30px;">
              <div 
                class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                [style.width.%]="progreso()">
                {{ progreso() }}%
              </div>
            </div>

            <div class="mt-4">
              @if (progreso() < 50) {
                <p class="text-muted">
                  <i class="bi bi-arrow-repeat spin me-2"></i>
                  Creando invitaciones...
                </p>
              } @else if (progreso() < 100) {
                <p class="text-muted">
                  <i class="bi bi-envelope-fill me-2"></i>
                  Enviando emails...
                </p>
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- PASO 4: Resultados -->
  @if (paso() === 4) {
    <div class="row">
      <div class="col-lg-8 mx-auto">
        <div class="card shadow-sm">
          <div class="card-header bg-success text-white text-center py-4">
            <i class="bi bi-check-circle-fill display-1"></i>
            <h2 class="mt-3 mb-0">¡Proceso Completado!</h2>
          </div>
          <div class="card-body p-4">
            <!-- Resultados de Creación -->
            <h5 class="mb-3">
              <i class="bi bi-file-earmark-plus me-2"></i>
              Creación de Invitaciones
            </h5>
            <div class="row g-3 mb-4">
              <div class="col-md-4">
                <div class="card bg-primary-subtle">
                  <div class="card-body text-center">
                    <h3 class="fw-bold text-primary">{{ resultadoCreacion().total }}</h3>
                    <p class="mb-0 text-muted">Total Procesadas</p>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card bg-success-subtle">
                  <div class="card-body text-center">
                    <h3 class="fw-bold text-success">{{ resultadoCreacion().exitosos }}</h3>
                    <p class="mb-0 text-muted">Creadas</p>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card bg-danger-subtle">
                  <div class="card-body text-center">
                    <h3 class="fw-bold text-danger">{{ resultadoCreacion().fallidos }}</h3>
                    <p class="mb-0 text-muted">Fallidas</p>
                  </div>
                </div>
              </div>
            </div>

            @if (resultadoCreacion().errores.length > 0) {
              <div class="alert alert-warning">
                <h6 class="alert-heading">
                  <i class="bi bi-exclamation-triangle me-2"></i>
                  Errores Encontrados
                </h6>
                <ul class="mb-0 small">
                  @for (error of resultadoCreacion().errores; track error) {
                    <li>{{ error }}</li>
                  }
                </ul>
              </div>
            }

            @if (enviarEmailsInmediatamente()) {
              <hr class="my-4">
              
              <!-- Resultados de Envío -->
              <h5 class="mb-3">
                <i class="bi bi-envelope-check me-2"></i>
                Envío de Emails
              </h5>
              <div class="row g-3 mb-4">
                <div class="col-md-4">
                  <div class="card bg-primary-subtle">
                    <div class="card-body text-center">
                      <h3 class="fw-bold text-primary">{{ resultadoEnvio().total }}</h3>
                      <p class="mb-0 text-muted">Total Intentos</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card bg-success-subtle">
                    <div class="card-body text-center">
                      <h3 class="fw-bold text-success">{{ resultadoEnvio().exitosos }}</h3>
                      <p class="mb-0 text-muted">Enviados</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card bg-danger-subtle">
                    <div class="card-body text-center">
                      <h3 class="fw-bold text-danger">{{ resultadoEnvio().fallidos }}</h3>
                      <p class="mb-0 text-muted">Fallidos</p>
                    </div>
                  </div>
                </div>
              </div>
            }

            <!-- Mensaje de Éxito -->
            <div class="alert alert-success d-flex align-items-center">
              <i class="bi bi-check-circle-fill fs-3 me-3"></i>
              <div>
                <strong>¡Proceso completado exitosamente!</strong>
                <p class="mb-0">Las invitaciones han sido creadas y están listas para ser gestionadas.</p>
              </div>
            </div>
          </div>

          <div class="card-footer bg-white">
            <div class="d-flex justify-content-between gap-2">
              <button class="btn btn-outline-secondary" (click)="reiniciar()">
                <i class="bi bi-arrow-repeat me-2"></i>
                Procesar Más
              </button>
              <button class="btn btn-primary btn-lg" (click)="finalizar()">
                <i class="bi bi-list-check me-2"></i>
                Ver Lista de Invitaciones
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  }
</div>

<style>
.spin {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
</style>
